# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository contains infrastructure-as-code for managing two Proxmox servers:
- **Nexus**: Critical infrastructure (Home Assistant, Pi-hole, Tailscale, Zigbee2MQTT)
- **Hatchery**: Resource-intensive services (Plex, Windows VMs)

The repository provides scripts, Docker configurations, and deployment templates for quick service configuration.

## Repository Structure

```
homelab/
├── nexus/              # Critical infrastructure services
│   ├── zigbee-mqtt/    # Mosquitto + Zigbee2MQTT setup
│   ├── home-assistant/ # Home Assistant configuration
│   ├── pihole/         # Pi-hole DNS configuration
│   └── tailscale/      # Tailscale exit node setup
├── hatchery/           # Resource-intensive services
│   ├── plex/           # Plex media server
│   └── windows-vms/    # Windows VM configurations
├── deployments/        # Production-ready configurations
│   ├── nexus/          # Finalized configs for Nexus
│   └── hatchery/       # Finalized configs for Hatchery
└── backups/            # Backup storage (gitignored)
```

## Zigbee-MQTT Commands (Nexus)

### Initial Setup
```bash
# From nexus/zigbee-mqtt directory
./setup.sh                          # Install to default /opt/docker
./setup.sh --install-dir ~/homelab  # Install to custom directory
```

### Docker Operations
```bash
# From the installation directory (e.g., /opt/docker)
docker-compose up -d          # Start all services
docker-compose down           # Stop all services
docker-compose logs -f        # View logs for all services
docker-compose logs mosquitto # View specific service logs
docker-compose restart zigbee2mqtt # Restart specific service
docker-compose pull          # Update Docker images
```

### Monitoring
```bash
# Install monitoring script (creates cron job)
sudo ./install-monitor.sh

# Manual health check
docker-compose ps  # Check container status
curl http://localhost:8080  # Test Zigbee2MQTT web UI
```

## Deployment Workflow

1. **Development**: Work in service directories (`nexus/*/` or `hatchery/*/`)
2. **Testing**: Test configurations locally or in development environment
3. **Production**: Copy final configs to `deployments/nexus/*/` or `deployments/hatchery/*/`
4. **Backup**: Store sensitive data and backups in `backups/` (gitignored)

## Zigbee-MQTT Architecture (Nexus)

### Service Structure
- **Mosquitto**: MQTT broker on ports 1883 (MQTT) and 9001 (WebSocket)
- **Zigbee2MQTT**: Zigbee gateway with web UI on port 8080, connects to Mosquitto for MQTT communication

### Installation Directory Layout
```
/opt/docker/ (or custom installation directory)
├── .env                          # Environment variables (generated by setup.sh)
├── docker-compose.yml            # Main compose file (generated from template)
├── mosquitto/
│   ├── config/
│   │   ├── mosquitto.conf       # MQTT broker configuration
│   │   └── passwd               # MQTT user credentials (hashed)
│   ├── data/                    # Persistent MQTT data
│   └── log/                     # MQTT logs
└── zigbee2mqtt/
    └── data/
        ├── configuration.yaml    # Zigbee2MQTT configuration
        ├── state.json           # Device states
        └── database.db          # Device database
```

### Key Scripts (in nexus/zigbee-mqtt/)
- **setup.sh**: Initializes environment, generates configs, creates MQTT users
- **install-monitor.sh**: Sets up cron-based monitoring for service health
- **monitor-zigbee.sh**: Health check script that restarts services if needed

### Configuration Flow
1. `setup.sh` reads `docker/.env.example` and `docker/docker-compose.yml.template`
2. Generates random MQTT credentials and creates `.env` file
3. Creates Mosquitto configuration with authentication
4. Generates Zigbee2MQTT config with MQTT connection details
5. Produces final `docker-compose.yml` with proper device mappings

### Important Configuration Files
- `.env`: Contains ZIGBEE_SERIAL_PORT, MQTT_USER, MQTT_PASS, TZ
- `mosquitto/config/mosquitto.conf`: MQTT broker settings, authentication config
- `zigbee2mqtt/data/configuration.yaml`: Device settings, MQTT connection, web UI config

## Development Notes

### General Repository Guidelines
- Each service has its own directory under `nexus/` or `hatchery/`
- Production-ready configurations go in `deployments/`
- Use `backups/` for sensitive data that shouldn't be in git
- Keep deployment files named with their standard names (e.g., `docker-compose.yml`)

### Zigbee-MQTT Specific Notes
- Environment variables in `.env` are used by both docker-compose.yml and passed to containers
- The `ZIGBEE_SERIAL_PORT` can be USB (`/dev/ttyUSB0`) or network (`tcp://host:port`)
- All generated files should be excluded from git (check .gitignore)
- Services depend on each other: Zigbee2MQTT requires Mosquitto to be healthy first

### Adding New Services
1. Create directory under appropriate server (`nexus/` or `hatchery/`)
2. Add setup scripts and documentation
3. Test thoroughly
4. Copy final configurations to `deployments/`