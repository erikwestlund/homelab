---
- name: Setup Development VM
  hosts: dev-vm
  become: yes
  gather_facts: yes
  vars_files:
    - ../secrets.yaml

  pre_tasks:
    - name: Ensure system is Ubuntu 24.04
      assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_version is version('24.04', '>=')
        msg: "This playbook requires Ubuntu 24.04 or later"

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Perform system upgrade
      apt:
        upgrade: dist
        update_cache: yes
      when: upgrade_system | default(false) | bool

  roles:
    - role: dev-vm
      tags:
        - dev-vm

  post_tasks:
    - name: Display post-installation message
      debug:
        msg: |
          Development VM setup complete!

          The following services have been installed and configured:
          - Docker CE with docker-compose
          {% if enable_podman | default(true) %}
          - Podman with podman-compose
          {% endif %}
          - Development tools (git, build-essential, etc.)
          - Programming languages (Python, Node.js{% if install_golang | default(true) %}, Go{% endif %}{% if install_rust | default(false) %}, Rust{% endif %})

          {% if dev_vm.github_token is defined %}
          GitHub authentication has been configured with your personal access token.
          {% endif %}

          To get started:
          1. Log out and log back in for group changes to take effect
          2. Test Docker: docker run hello-world
          3. Test Podman: podman run hello-world
          4. Your workspace is at: ~/workspace

          Useful aliases have been configured. Type 'alias' to see them all.

    - name: Check if reboot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Notify if reboot is required
      debug:
        msg: "A system reboot is required to complete the installation. Please run: sudo reboot"
      when: reboot_required.stat.exists