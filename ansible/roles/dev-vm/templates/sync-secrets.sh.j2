#!/usr/bin/env bash

# Sync secrets from cloud storage
# Based on dotfiles/scripts/sync-secrets.sh

# Check if rclone is configured
if ! rclone listremotes | grep -q "config:"; then
    echo "Error: rclone remote 'config:' not found"
    echo "Please configure rclone first"
    exit 1
fi

# Create necessary directories
mkdir -p ~/.config/rclone
mkdir -p ~/.ssh
mkdir -p ~/.aws
mkdir -p ~/code/homelab/ansible
mkdir -p ~/.secrets

# Sync rclone config
echo "Syncing rclone config..."
rclone copy config:/erik-config/rclone/rclone.conf ~/.config/rclone/

# Sync SSH keys
echo "Syncing SSH keys..."
rclone sync config:/erik-config/ssh/ ~/.ssh/
chmod 700 ~/.ssh
chmod 600 ~/.ssh/*
chmod 644 ~/.ssh/*.pub 2>/dev/null || true

# Sync AWS config
echo "Syncing AWS config..."
rclone sync config:/erik-config/aws/ ~/.aws/

# Homelab ansible secrets
echo "Syncing homelab ansible secrets..."
rclone copy config:/erik-config/homelab/ansible/secrets.yaml ~/code/homelab/ansible/

# API keys
echo "Syncing API keys..."
rclone copy config:/erik-config/secrets/api-keys ~/.secrets/
chmod 600 ~/.secrets/api-keys

# Source API keys if they exist
if [[ -f ~/.secrets/api-keys ]]; then
    source ~/.secrets/api-keys
fi

echo "Secrets sync complete!"