#!/usr/bin/env bash

# Script to add Zen MCP server configuration to Claude projects
# Usage: addzen [project_name]

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# API keys file location
KEYS_FILE="$HOME/.secrets/api-keys"

# Check if API keys file exists
if [[ ! -f "$KEYS_FILE" ]]; then
    echo "${RED}Error: API keys file not found at $KEYS_FILE${NC}"
    echo "Please create it with: export OPENROUTER_API_KEY='your-key-here'"
    exit 1
fi

# Source the API keys file
source "$KEYS_FILE"

# Check if API key is set
if [[ -z "$OPENROUTER_API_KEY" ]]; then
    echo "${RED}Error: OPENROUTER_API_KEY not found in $KEYS_FILE${NC}"
    echo "Please add: export OPENROUTER_API_KEY='your-key-here'"
    exit 1
fi

# Get project name from argument or prompt
if [[ -n "$1" ]]; then
    PROJECT_NAME="$1"
else
    echo "Enter project name (as it appears in .claude.json): "
    read PROJECT_NAME
fi

# Claude config file
CLAUDE_CONFIG="$HOME/.claude.json"

# Check if .claude.json exists
if [[ ! -f "$CLAUDE_CONFIG" ]]; then
    echo "${RED}Error: $CLAUDE_CONFIG not found${NC}"
    exit 1
fi

# Check if jq is installed
if ! command -v jq &> /dev/null; then
    echo "${RED}Error: jq is not installed. Install it with: sudo apt install jq${NC}"
    exit 1
fi

# Create the Zen MCP configuration
ZEN_CONFIG=$(cat <<EOF
{
  "zen": {
    "command": "uvx",
    "args": [
      "--from",
      "git+https://github.com/BeehiveInnovations/zen-mcp-server.git",
      "zen-mcp-server"
    ],
    "env": {
      "OPENROUTER_API_KEY": "$OPENROUTER_API_KEY"
    }
  }
}
EOF
)

# Check if project exists in config
if ! jq -e ".projects[\"$PROJECT_NAME\"]" "$CLAUDE_CONFIG" > /dev/null 2>&1; then
    echo "${RED}Error: Project '$PROJECT_NAME' not found in $CLAUDE_CONFIG${NC}"
    echo ""
    echo "Available projects:"
    jq -r '.projects | keys[]' "$CLAUDE_CONFIG" 2>/dev/null | head -20
    exit 1
fi

# Check if mcpServers already exists for this project
if jq -e ".projects[\"$PROJECT_NAME\"].mcpServers" "$CLAUDE_CONFIG" > /dev/null 2>&1; then
    # Check if zen already exists
    if jq -e ".projects[\"$PROJECT_NAME\"].mcpServers.zen" "$CLAUDE_CONFIG" > /dev/null 2>&1; then
        echo "${YELLOW}Zen MCP server already configured for project '$PROJECT_NAME'${NC}"
        echo "Do you want to update it? (y/n): "
        read -r RESPONSE
        if [[ "$RESPONSE" != "y" ]]; then
            echo "Aborted."
            exit 0
        fi
    fi
    # Add zen to existing mcpServers
    jq ".projects[\"$PROJECT_NAME\"].mcpServers += $ZEN_CONFIG" "$CLAUDE_CONFIG" > "$CLAUDE_CONFIG.tmp"
else
    # Create mcpServers with zen
    jq ".projects[\"$PROJECT_NAME\"].mcpServers = $ZEN_CONFIG" "$CLAUDE_CONFIG" > "$CLAUDE_CONFIG.tmp"
fi

# Move the updated config back
if [[ -f "$CLAUDE_CONFIG.tmp" ]]; then
    mv "$CLAUDE_CONFIG.tmp" "$CLAUDE_CONFIG"
    echo "${GREEN}âœ“ Zen MCP server added to project '$PROJECT_NAME'${NC}"
    echo ""
    echo "Configuration added:"
    jq ".projects[\"$PROJECT_NAME\"].mcpServers.zen" "$CLAUDE_CONFIG"
else
    echo "${RED}Error: Failed to update configuration${NC}"
    exit 1
fi