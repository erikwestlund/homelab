---
# Performance configuration

- name: Check if swap file exists
  stat:
    path: /swapfile
  register: swap_file_check
  become: yes

- name: Create swap file
  command: dd if=/dev/zero of=/swapfile bs=1G count={{ swap_size_gb }} status=progress
  become: yes
  when:
    - configure_swap | bool
    - not swap_file_check.stat.exists

- name: Set swap file permissions
  file:
    path: /swapfile
    owner: root
    group: root
    mode: '0600'
  become: yes
  when: configure_swap | bool

- name: Make swap file
  command: mkswap /swapfile
  become: yes
  when:
    - configure_swap | bool
    - not swap_file_check.stat.exists

- name: Enable swap file
  command: swapon /swapfile
  become: yes
  when:
    - configure_swap | bool
    - not swap_file_check.stat.exists

- name: Add swap to fstab
  lineinfile:
    path: /etc/fstab
    line: '/swapfile none swap sw 0 0'
    state: present
  become: yes
  when: configure_swap | bool

- name: Configure swappiness
  sysctl:
    name: vm.swappiness
    value: '10'
    state: present
    reload: yes
  become: yes
  when: configure_swap | bool

- name: Configure cache pressure
  sysctl:
    name: vm.vfs_cache_pressure
    value: '50'
    state: present
    reload: yes
  become: yes
  when: configure_swap | bool

- name: Configure Docker log rotation
  copy:
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "100m",
          "max-file": "5"
        }
      }
    dest: /etc/docker/daemon.json.d/log-rotation.json
    owner: root
    group: root
    mode: '0644'
  become: yes
  when: false  # This is handled in docker-daemon.json.j2

- name: Load bridge module for container networking
  modprobe:
    name: br_netfilter
    state: present
  become: yes
  ignore_errors: yes

- name: Set up kernel parameters for better container performance
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { key: 'net.ipv4.ip_forward', value: '1' }
    - { key: 'fs.inotify.max_user_instances', value: '524288' }
    - { key: 'fs.inotify.max_user_watches', value: '524288' }
  become: yes

- name: Set up bridge kernel parameters (if bridge module loaded)
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
  become: yes
  ignore_errors: yes