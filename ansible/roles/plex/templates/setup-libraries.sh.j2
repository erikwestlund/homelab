#!/bin/bash
# Setup Plex Libraries
# Generated by Ansible - do not edit directly

echo "Setting up Plex libraries..."
echo "Make sure you've completed the initial Plex setup first!"
echo ""

# Check if Plex is claimed
if [ ! -f "{{ plex_config_dir }}/Library/Application Support/Plex Media Server/Preferences.xml" ]; then
    echo "Plex preferences file not found. Please complete initial setup first."
    exit 1
fi

# Get Plex token
echo "Getting Plex authentication token..."
PREF_FILE="{{ plex_config_dir }}/Library/Application Support/Plex Media Server/Preferences.xml"

# Debug: Check if file exists and show path
echo "Looking for preferences at: $PREF_FILE"
if [ -f "$PREF_FILE" ]; then
    echo "Preferences file found!"
    # Try different methods to extract token
    PLEX_TOKEN=$(grep -o 'PlexOnlineToken="[^"]*"' "$PREF_FILE" | cut -d'"' -f2 || true)
    
    # Debug: Show what we found
    echo "Token search result: ${PLEX_TOKEN:0:10}..." 
else
    echo "Preferences file not found at expected location!"
    echo "Checking container..."
    docker exec plex find /config -name "Preferences.xml" -type f 2>/dev/null || true
    exit 1
fi

if [ -z "$PLEX_TOKEN" ]; then
    echo "Could not extract Plex token from preferences."
    echo "Please ensure you have:"
    echo "1. Signed into Plex"
    echo "2. Claimed the server" 
    echo "3. Waited for settings to save"
    exit 1
fi

echo "Found Plex token!"

# Function to add library
add_library() {
    local name="$1"
    local type="$2"
    local path="$3"
    
    echo "Adding library: $name ($type) at $path"
    
    # URL encode the parameters
    encoded_name=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$name'))")
    encoded_path=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$path'))")
    
    # Add the library
    curl -X POST \
        "http://localhost:32400/library/sections?name=${encoded_name}&type=${type}&agent=tv.plex.agents.movie&scanner=Plex%20Movie%20Scanner&language=en&location=${encoded_path}&X-Plex-Token=${PLEX_TOKEN}" \
        -H "Accept: application/json" \
        -s
    
    echo " - Added $name"
}

# Add each library
{% for lib in plex_libraries %}
add_library "{{ lib.name }}" "{{ lib.type }}" "{{ lib.path }}"
{% endfor %}

echo ""
echo "Libraries added! Scanning for media..."

# Trigger library scan
curl -X GET "http://localhost:32400/library/sections/all/refresh?X-Plex-Token=${PLEX_TOKEN}" -s

echo "Library setup complete!"
echo "You can view your libraries at http://{{ ansible_host }}:32400/web"