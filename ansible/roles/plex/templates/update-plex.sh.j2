#!/bin/bash
# Plex update script
# Generated by Ansible - do not edit directly

set -e

echo "Updating Plex Media Server..."

# Pull latest image
docker pull {{ plex_image }}

# Stop and remove old container
docker stop {{ plex_container_name }} || true
docker rm {{ plex_container_name }} || true

# Start new container
docker run -d \
  --name={{ plex_container_name }} \
  --network={{ plex_network_mode }} \
  --restart=unless-stopped \
  -e PUID={{ plex_puid }} \
  -e PGID={{ plex_pgid }} \
  -e TZ={{ plex_timezone }} \
  -e VERSION=docker \
{% if plex_claim_token %}
  -e PLEX_CLAIM={{ plex_claim_token }} \
{% endif %}
  -v {{ plex_config_dir }}:/config \
  -v /media:/media \
{% if plex_enable_hw_transcoding and dri_device.stat.exists %}
  --device=/dev/dri:/dev/dri \
{% endif %}
  --memory={{ plex_memory_limit }} \
  --cpu-shares={{ plex_cpu_shares }} \
  {{ plex_image }}

echo "Plex update complete!"
echo "Access Plex at: http://$(hostname -I | awk '{print $1}'):{{ plex_port }}"