#!/bin/bash
# Monitor NAS mount and remount if needed
# Generated by Ansible - do not edit directly

MOUNT_POINT="/media"
LOG_FILE="/var/log/nas-mount-monitor.log"

# Function to log messages
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Check if mount point exists and has content
if ! mountpoint -q "$MOUNT_POINT"; then
    log_message "ERROR: $MOUNT_POINT is not mounted!"
    
    # Try to remount
    log_message "Attempting to remount NAS..."
    mount -a
    
    # Check if remount was successful
    if mountpoint -q "$MOUNT_POINT"; then
        log_message "SUCCESS: NAS remounted successfully"
        # Restart Plex to ensure it sees the mount
        docker restart plex
        log_message "Plex container restarted"
    else
        log_message "FAILED: Could not remount NAS"
        exit 1
    fi
else
    # Mount exists, check if we can see expected directories
    if [ -d "$MOUNT_POINT/Movies" ] && [ -d "$MOUNT_POINT/TV Shows" ]; then
        # All good, silent success
        exit 0
    else
        log_message "WARNING: Mount exists but expected directories not found"
        # Try remounting
        umount "$MOUNT_POINT" 2>/dev/null
        mount -a
        if [ -d "$MOUNT_POINT/Movies" ]; then
            log_message "SUCCESS: Remounted and directories visible"
            docker restart plex
        else
            log_message "FAILED: Mount issues persist"
            exit 1
        fi
    fi
fi