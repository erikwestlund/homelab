---
# Sync from Google Drive to local directory using rclone

- name: Install rclone
  apt:
    name: rclone
    state: present

- name: Create rclone config directory
  file:
    path: /root/.config/rclone
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: Deploy rclone config for Google Drive
  copy:
    content: |
      [{{ gdrive_sync_remote }}]
      type = drive
      client_id = {{ rclone_gdrive_client_id }}
      client_secret = {{ rclone_gdrive_client_secret }}
      scope = drive
      token = {{ rclone_gdrive_token }}
      team_drive =
    dest: /root/.config/rclone/rclone.conf
    owner: root
    group: root
    mode: '0600'
  no_log: true

- name: Create destination directory
  file:
    path: "{{ gdrive_sync_dest }}"
    state: directory
    owner: "{{ syncthing_user }}"
    group: "{{ syncthing_group }}"
    mode: '0755'

- name: Create Google Drive sync script
  template:
    src: gdrive-sync.sh.j2
    dest: /usr/local/bin/gdrive-sync
    owner: root
    group: root
    mode: '0755'

- name: Create systemd service for Google Drive sync
  copy:
    content: |
      [Unit]
      Description=Sync from Google Drive to local
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/gdrive-sync
      User=root

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/gdrive-sync.service
    mode: '0644'

- name: Create systemd timer for Google Drive sync
  copy:
    content: |
      [Unit]
      Description=Run Google Drive sync periodically

      [Timer]
      OnCalendar={{ gdrive_sync_schedule }}
      Persistent=true
      RandomizedDelaySec=60

      [Install]
      WantedBy=timers.target
    dest: /etc/systemd/system/gdrive-sync.timer
    mode: '0644'

- name: Enable and start Google Drive sync timer
  systemd:
    name: gdrive-sync.timer
    enabled: yes
    state: started
    daemon_reload: yes

- name: Run initial Google Drive sync
  command: /usr/local/bin/gdrive-sync
  async: 3600
  poll: 0
  when: gdrive_sync_run_initial | default(true)

- name: Display Google Drive sync info
  debug:
    msg:
      - "Google Drive sync configured:"
      - "  Remote: {{ gdrive_sync_remote }}:{{ gdrive_sync_remote_path }}"
      - "  Destination: {{ gdrive_sync_dest }}"
      - "  Schedule: {{ gdrive_sync_schedule }}"
      - "  Manual run: sudo /usr/local/bin/gdrive-sync"
